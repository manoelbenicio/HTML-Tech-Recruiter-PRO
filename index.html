<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS Recruiter Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar { transition: margin-left .3s; }
        .modal-content { animation: slide-down 0.3s ease-out; }
        @keyframes slide-down {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .tab-content > div { display: none; }
        .tab-content > .active { display: block; }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800" x-data="app()">

    <!-- Sidebar -->
    <div class="fixed top-0 left-0 h-full bg-slate-900 text-white w-64 p-5 z-20 sidebar flex flex-col" :class="{ '-ml-64': !sidebarOpen }">
        <h1 class="text-2xl font-bold mb-10 text-center">DS Recruiter Pro</h1>
        <nav class="flex-grow">
            <a @click="changeTab('dashboard')" href="#" class="flex items-center p-3 rounded-lg transition-colors" :class="activeTab === 'dashboard' ? 'bg-slate-700' : 'hover:bg-slate-800'">
                <i class="bi bi-speedometer2 mr-3"></i> Dashboard
            </a>
            <a @click="changeTab('vagas')" href="#" class="flex items-center p-3 rounded-lg transition-colors mt-2" :class="activeTab === 'vagas' ? 'bg-slate-700' : 'hover:bg-slate-800'">
                <i class="bi bi-briefcase-fill mr-3"></i> Vagas
            </a>
            <a @click="changeTab('candidatos')" href="#" class="flex items-center p-3 rounded-lg transition-colors mt-2" :class="activeTab === 'candidatos' ? 'bg-slate-700' : 'hover:bg-slate-800'">
                <i class="bi bi-people-fill mr-3"></i> Candidatos
            </a>
            <a @click="changeTab('entrevistas')" href="#" class="flex items-center p-3 rounded-lg transition-colors mt-2" :class="activeTab === 'entrevistas' ? 'bg-slate-700' : 'hover:bg-slate-800'">
                <i class="bi bi-calendar-check-fill mr-3"></i> Entrevistas
            </a>
        </nav>
        <div class="text-center text-xs text-slate-500">
            <p>Versão 2.3</p>
            <p>&copy; 2025 Minsait</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 transition-all duration-300" :class="{ 'ml-64': sidebarOpen, 'ml-0': !sidebarOpen }">
        <!-- Header -->
        <header class="bg-white shadow-md p-4 flex justify-between items-center">
            <button @click="sidebarOpen = !sidebarOpen" class="text-slate-800 hover:text-blue-600">
                <i class="bi bi-list text-2xl"></i>
            </button>
            <div class="flex items-center">
                <button @click="openModal('uploadCVs')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                    <i class="bi bi-upload mr-2"></i> Upload CVs
                </button>
                <div class="ml-4">
                    <span class="font-semibold" x-text="auth.currentUser ? auth.currentUser.uid.substring(0, 8) : 'Autenticando...'"></span>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="p-6 tab-content">
            <!-- Dashboard -->
            <div id="dashboard" :class="{ 'active': activeTab === 'dashboard' }">
                <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between">
                        <div>
                            <p class="text-gray-500">Vagas Ativas</p>
                            <p class="text-3xl font-bold" x-text="vagas.filter(v => v.status === 'Ativa').length"></p>
                        </div>
                        <i class="bi bi-briefcase-fill text-blue-500 text-4xl"></i>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between">
                        <div>
                            <p class="text-gray-500">Total de Candidatos</p>
                            <p class="text-3xl font-bold" x-text="candidatos.length"></p>
                        </div>
                        <i class="bi bi-people-fill text-green-500 text-4xl"></i>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between">
                        <div>
                            <p class="text-gray-500">Aguardando Feedback</p>
                            <p class="text-3xl font-bold" x-text="candidatos.filter(c => c.jornada && c.jornada.status.includes('Aguardando')).length"></p>
                        </div>
                        <i class="bi bi-hourglass-split text-yellow-500 text-4xl"></i>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between">
                        <div>
                            <p class="text-gray-500">Entrevistas Agendadas</p>
                             <p class="text-3xl font-bold" x-text="candidatos.filter(c => c.jornada && c.jornada.status === 'Entrevista Agendada').length"></p>
                        </div>
                        <i class="bi bi-calendar2-check-fill text-red-500 text-4xl"></i>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">Ranking de Candidatos por Prática</h3>
                        <div class="mb-4">
                            <label for="praticaFilter" class="sr-only">Filtrar por Prática</label>
                            <select id="praticaFilter" x-model="filtroPratica" class="w-full p-2 border rounded-lg bg-gray-50">
                                <option value="Desenvolvimento de Soluções">Desenvolvimento de Soluções (Java, .NET)</option>
                                <option value="Infra/DIC">Infra/DIC (DevOps, Cloud)</option>
                                <option value="Dados">Dados (IA, RPA, SQL, Big Data)</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="border-b">
                                        <th class="p-3">#</th>
                                        <th class="p-3">Candidato</th>
                                        <th class="p-3">Prática</th>
                                        <th class="p-3">Score Prática</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(candidato, index) in rankingPorPratica()" :key="candidato.id">
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="p-3" x-text="index + 1"></td>
                                            <td class="p-3 font-semibold" x-text="candidato.nome"></td>
                                            <td class="p-3" x-text="candidato.pratica"></td>
                                            <td class="p-3">
                                                <span class="font-bold text-blue-600" x-text="candidato.scorePratica ? candidato.scorePratica.toFixed(2) : 'N/A'"></span>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">Distribuição por Prática</h3>
                        <canvas id="praticaChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Vagas -->
            <div id="vagas" :class="{ 'active': activeTab === 'vagas' }">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Gerenciamento de Vagas</h2>
                    <button @click="openModal('novaVaga')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center">
                        <i class="bi bi-plus-circle-fill mr-2"></i> Nova Vaga
                    </button>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b">
                                    <th class="p-3">Título</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3">Candidatos Aplicados</th>
                                    <th class="p-3">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-if="isLoading">
                                    <tr>
                                        <td colspan="4" class="text-center p-4 text-gray-500">Carregando vagas...</td>
                                    </tr>
                                </template>
                                <template x-if="!isLoading && vagas.length === 0">
                                    <tr>
                                        <td colspan="4" class="text-center p-4 text-gray-500">Nenhuma vaga cadastrada.</td>
                                    </tr>
                                </template>
                                <template x-for="vaga in vagas" :key="vaga.id">
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="p-3 font-semibold" x-text="vaga.titulo"></td>
                                        <td class="p-3">
                                            <span class="px-2 py-1 text-sm rounded-full" :class="{
                                                'bg-green-200 text-green-800': vaga.status === 'Ativa',
                                                'bg-yellow-200 text-yellow-800': vaga.status === 'Pausada',
                                                'bg-red-200 text-red-800': vaga.status === 'Fechada'
                                            }" x-text="vaga.status"></span>
                                        </td>
                                        <td class="p-3" x-text="contarCandidatosPorVaga(vaga.id)"></td>
                                        <td class="p-3">
                                            <button @click="verVaga(vaga)" class="text-blue-600 hover:text-blue-800 mr-3"><i class="bi bi-eye-fill"></i></button>
                                            <button @click="editarVaga(vaga)" class="text-yellow-600 hover:text-yellow-800 mr-3"><i class="bi bi-pencil-fill"></i></button>
                                            <button @click="excluirVaga(vaga.id)" class="text-red-600 hover:text-red-800"><i class="bi bi-trash-fill"></i></button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Candidatos -->
            <div id="candidatos" :class="{ 'active': activeTab === 'candidatos' }">
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Gerenciamento de Candidatos</h2>
                    <button @click="showToast('Funcionalidade em desenvolvimento.', 'info')" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center">
                        <i class="bi bi-layout-three-columns mr-2"></i> Gerenciar Colunas
                    </button>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b">
                                    <th class="p-3">Nome</th>
                                    <th class="p-3">E-mail</th>
                                    <th class="p-3">CPF</th>
                                    <th class="p-3">Origem</th>
                                    <th class="p-3">Status Entrevista</th>
                                    <th class="p-3">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-if="isLoading">
                                    <tr>
                                        <td colspan="6" class="text-center p-4 text-gray-500">Carregando candidatos...</td>
                                    </tr>
                                </template>
                                <template x-if="!isLoading && candidatos.length === 0">
                                    <tr>
                                        <td colspan="6" class="text-center p-4 text-gray-500">Nenhum candidato cadastrado.</td>
                                    </tr>
                                </template>
                                <template x-for="candidato in candidatos" :key="candidato.id">
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="p-3 font-semibold" x-text="candidato.nome"></td>
                                        <td class="p-3" x-text="candidato.email || '-'"></td>
                                        <td class="p-3" x-text="candidato.cpf || '-'"></td>
                                        <td class="p-3" x-text="candidato.origem || '-'"></td>
                                        <td class="p-3">
                                             <span class="px-2 py-1 text-xs rounded-full" :class="getStatusClass(candidato.jornada?.status)" x-text="candidato.jornada?.status || 'Não iniciado'"></span>
                                        </td>
                                        <td class="p-3">
                                            <button @click="verCandidato(candidato)" class="text-blue-600 hover:text-blue-800 mr-3" title="Ver Detalhes"><i class="bi bi-person-lines-fill"></i></button>
                                            <button @click="gerarCVMinsait(candidato)" class="text-purple-600 hover:text-purple-800" title="Gerar CV Minsait"><i class="bi bi-file-earmark-word-fill"></i></button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Entrevistas e Feedback -->
            <div id="entrevistas" :class="{ 'active': activeTab === 'entrevistas' }">
                <h2 class="text-3xl font-bold mb-6">Painel de Entrevistas e Feedback</h2>
                
                <!-- Entrevistas Agendadas -->
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center"><i class="bi bi-calendar2-check text-red-500 mr-3"></i>Entrevistas Agendadas</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b">
                                    <th class="p-3">Candidato</th>
                                    <th class="p-3">Data</th>
                                    <th class="p-3">Gestor</th>
                                    <th class="p-3">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="candidato in entrevistasAgendadas()" :key="candidato.id">
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="p-3 font-semibold" x-text="candidato.nome"></td>
                                        <td class="p-3" x-text="formatarData(candidato.jornada.dataEntrevista)"></td>
                                        <td class="p-3" x-text="candidato.jornada.gestor"></td>
                                        <td class="p-3">
                                            <span class="px-2 py-1 text-xs rounded-full" :class="getStatusClass(candidato.jornada.status)" x-text="candidato.jornada.status"></span>
                                        </td>
                                    </tr>
                                </template>
                                <template x-if="entrevistasAgendadas().length === 0">
                                    <tr><td colspan="4" class="text-center p-4 text-gray-500">Nenhuma entrevista agendada.</td></tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Candidatos Aguardando Feedback -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4 flex items-center"><i class="bi bi-hourglass-bottom text-yellow-500 mr-3"></i>Candidatos Aguardando Feedback</h3>
                     <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b">
                                    <th class="p-3">Candidato</th>
                                    <th class="p-3">Data da Entrevista</th>
                                    <th class="p-3">Gestor</th>
                                    <th class="p-3">Dias Aguardando</th>
                                    <th class="p-3">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="candidato in aguardandoFeedback()" :key="candidato.id">
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="p-3 font-semibold" x-text="candidato.nome"></td>
                                        <td class="p-3" x-text="formatarData(candidato.jornada.dataEntrevista)"></td>
                                        <td class="p-3" x-text="candidato.jornada.gestor"></td>
                                        <td class="p-3" x-text="calcularDiasAguardando(candidato.jornada.dataEntrevista)"></td>
                                        <td class="p-3">
                                            <span class="px-2 py-1 text-xs rounded-full" :class="getStatusClass(candidato.jornada.status)" x-text="candidato.jornada.status"></span>
                                        </td>
                                    </tr>
                                </template>
                                <template x-if="aguardandoFeedback().length === 0">
                                    <tr><td colspan="5" class="text-center p-4 text-gray-500">Nenhum candidato aguardando feedback.</td></tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div x-show="modal.open" class="fixed inset-0 bg-black bg-opacity-50 z-30 flex items-center justify-center p-4" x-cloak @click.self="closeModal()">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-4xl modal-content max-h-[90vh] overflow-y-auto" @click.stop>
            
            <!-- Modal Nova Vaga -->
            <template x-if="modal.type === 'novaVaga'">
                <div>
                    <h3 class="text-2xl font-bold mb-6" x-text="editMode ? 'Editar Vaga' : 'Criar Nova Vaga'"></h3>
                    <form @submit.prevent="salvarVaga">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="vagaTitulo" class="block mb-1 font-semibold">Título da Vaga</label>
                                <input type="text" id="vagaTitulo" x-model="formVaga.titulo" class="w-full p-2 border rounded-lg" required>
                            </div>
                            <div>
                                <label for="vagaStatus" class="block mb-1 font-semibold">Status</label>
                                <select id="vagaStatus" x-model="formVaga.status" class="w-full p-2 border rounded-lg bg-white" required>
                                    <option>Ativa</option>
                                    <option>Pausada</option>
                                    <option>Fechada</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label for="vagaDescricao" class="block mb-1 font-semibold">Descrição (Requisitos)</label>
                            <textarea id="vagaDescricao" x-model="formVaga.descricao" rows="5" class="w-full p-2 border rounded-lg" required></textarea>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button type="button" @click="closeModal()" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 mr-3">Cancelar</button>
                            <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700" x-text="editMode ? 'Salvar Alterações' : 'Criar Vaga'"></button>
                        </div>
                    </form>
                </div>
            </template>

            <!-- Modal Upload CVs -->
            <template x-if="modal.type === 'uploadCVs'">
                <div>
                    <h3 class="text-2xl font-bold mb-6">Upload de Currículos</h3>
                    <div class="relative border-2 border-dashed border-gray-300 rounded-lg p-10 text-center">
                        <i class="bi bi-cloud-arrow-up-fill text-5xl text-gray-400"></i>
                        <p class="mt-4">Arraste e solte os arquivos aqui ou clique para selecionar.</p>
                        <p class="text-sm text-gray-500">Formatos suportados: PDF, DOCX</p>
                        <input type="file" @change="handleFileUpload($event)" multiple class="opacity-0 absolute inset-0 w-full h-full cursor-pointer">
                    </div>
                    <div class="mt-4">
                        <template x-for="file in uploadedFiles" :key="file.name">
                            <div class="flex justify-between items-center p-2 bg-gray-100 rounded-lg mb-2">
                                <span x-text="file.name"></span>
                                <i class="bi bi-check-circle-fill text-green-500"></i>
                            </div>
                        </template>
                    </div>
                    <div class="mt-4">
                        <label for="vagaAssociada" class="block mb-1 font-semibold">Analisar contra a vaga:</label>
                        <select id="vagaAssociada" x-model="vagaParaAnalise" class="w-full p-2 border rounded-lg bg-white">
                            <option value="">Nenhuma (Análise Geral)</option>
                            <template x-for="vaga in vagas.filter(v => v.status === 'Ativa')" :key="vaga.id">
                                <option :value="vaga.id" x-text="vaga.titulo"></option>
                            </template>
                        </select>
                    </div>
                    <div class="mt-6 flex justify-end z-10 relative">
                        <button type="button" @click="closeModal()" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 mr-3">Cancelar</button>
                        <button @click="processarUploads" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700" :disabled="uploadedFiles.length === 0">Processar</button>
                    </div>
                </div>
            </template>

            <!-- Modal Detalhes do Candidato -->
            <template x-if="modal.type === 'verCandidato'">
                <div x-if="candidatoSelecionado">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="text-2xl font-bold" x-text="candidatoSelecionado.nome"></h3>
                            <p class="text-gray-600" x-text="candidatoSelecionado.pratica"></p>
                        </div>
                         <button @click="gerarCVMinsait(candidatoSelecionado)" class="bg-purple-600 text-white px-3 py-2 rounded-lg hover:bg-purple-700 flex items-center text-sm">
                            <i class="bi bi-file-earmark-word-fill mr-2"></i> Gerar CV Minsait
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Coluna Esquerda: Dados e Scores -->
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-bold text-lg mb-2">Dados Pessoais</h4>
                                <div class="space-y-2 text-sm p-4 bg-gray-50 rounded-lg">
                                    <p><strong>E-mail:</strong> <input type="email" x-model="candidatoSelecionado.email" @blur="salvarCandidato(candidatoSelecionado)" class="w-full p-1 border rounded"></p>
                                    <p><strong>CPF:</strong> <input type="text" x-model="candidatoSelecionado.cpf" @blur="salvarCandidato(candidatoSelecionado)" class="w-full p-1 border rounded"></p>
                                    <p><strong>CEP:</strong> <input type="text" x-model="candidatoSelecionado.cep" @blur="buscarCep(candidatoSelecionado)" class="w-full p-1 border rounded"></p>
                                    <p><strong>Endereço:</strong> <span x-text="candidatoSelecionado.endereco || '...' "></span></p>
                                    <p><strong>Origem:</strong> <input type="text" x-model="candidatoSelecionado.origem" @blur="salvarCandidato(candidatoSelecionado)" class="w-full p-1 border rounded"></p>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg mb-2">Scores</h4>
                                <div class="space-y-2 text-sm p-4 bg-gray-50 rounded-lg">
                                    <p><strong>Score Prática:</strong> <span class="text-xl font-bold text-blue-600" x-text="candidatoSelecionado.scorePratica ? candidatoSelecionado.scorePratica.toFixed(2) : 'N/A'"></span></p>
                                    <div>
                                        <p><strong>Scores por Vaga:</strong></p>
                                        <ul>
                                            <template x-for="vagaId in Object.keys(candidatoSelecionado.scores || {})" :key="vagaId">
                                                <li>
                                                    <span x-text="getVagaById(vagaId)?.titulo || 'Vaga desconhecida'"></span>:
                                                    <span class="font-bold text-green-600" x-text="candidatoSelecionado.scores[vagaId].total.toFixed(2)"></span>
                                                </li>
                                            </template>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Coluna Direita: Jornada e Feedbacks -->
                        <div class="space-y-6">
                             <div>
                                <h4 class="font-bold text-lg mb-2">Jornada da Entrevista</h4>
                                <div class="space-y-2 text-sm p-4 bg-gray-50 rounded-lg">
                                    <p><strong>Status:</strong> 
                                        <select x-model="candidatoSelecionado.jornada.status" @change="salvarCandidato(candidatoSelecionado)" class="w-full p-1 border rounded bg-white">
                                            <option>Não iniciado</option>
                                            <option>Aguardando feedback do Gestor (CV)</option>
                                            <option>Entrevista Agendada</option>
                                            <option>Aguardando feedback do Gestor (Entrevista)</option>
                                            <option>Aprovado</option>
                                            <option>Reprovado</option>
                                        </select>
                                    </p>
                                    <p><strong>Data da Entrevista:</strong> <input type="date" x-model="candidatoSelecionado.jornada.dataEntrevista" @blur="salvarCandidato(candidatoSelecionado)" class="w-full p-1 border rounded"></p>
                                    <p><strong>Gestor:</strong> <input type="text" x-model="candidatoSelecionado.jornada.gestor" @blur="salvarCandidato(candidatoSelecionado)" class="w-full p-1 border rounded"></p>
                                    <p><strong>Convite Enviado:</strong> <input type="checkbox" x-model="candidatoSelecionado.jornada.conviteEnviado" @change="salvarCandidato(candidatoSelecionado)" class="rounded"></p>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg mb-2">Observações e Feedbacks</h4>
                                <div class="space-y-2">
                                    <div>
                                        <label class="font-semibold">Recrutador:</label>
                                        <textarea x-model="candidatoSelecionado.obs_recrutador" @blur="salvarCandidato(candidatoSelecionado)" class="w-full p-1 border rounded mt-1" rows="2"></textarea>
                                    </div>
                                    <div>
                                        <label class="font-semibold">Cliente:</label>
                                        <textarea x-model="candidatoSelecionado.obs_cliente" @blur="salvarCandidato(candidatoSelecionado)" class="w-full p-1 border rounded mt-1" rows="2"></textarea>
                                    </div>
                                    <div class="text-sm p-4 bg-gray-50 rounded-lg">
                                        <p><strong>Feedback IA:</strong> <span x-text="candidatoSelecionado.feedback_ia || 'Aguardando análise.'"></span></p>
                                        <p><strong>Feedback Prova/Teste:</strong> <textarea x-model="candidatoSelecionado.feedback_prova" @blur="salvarCandidato(candidatoSelecionado)" class="w-full p-1 border rounded mt-1" rows="2"></textarea></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end border-t pt-4">
                        <button type="button" @click="closeModal()" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Fechar</button>
                    </div>
                </div>
            </template>

            <!-- Modal Gerar CV Minsait -->
            <template x-if="modal.type === 'gerarCVMinsait'">
                <div x-if="candidatoSelecionado">
                    <h3 class="text-2xl font-bold mb-4">Gerar CV Padrão Minsait</h3>
                    <h4 class="text-xl font-semibold mb-6" x-text="candidatoSelecionado.nome"></h4>
                    <div class="p-4 border rounded-lg bg-gray-50 max-h-96 overflow-y-auto">
                        <!-- Formulário editável do esqueleto do CV -->
                        <div class="space-y-4">
                            <div>
                                <label class="block font-semibold">Resumo Profissional</label>
                                <textarea x-model="cvMinsait.resumo" class="w-full p-2 border rounded-lg mt-1" rows="4"></textarea>
                            </div>
                            <div>
                                <label class="block font-semibold">Histórico Profissional</label>
                                <textarea x-model="cvMinsait.historico" class="w-full p-2 border rounded-lg mt-1" rows="6"></textarea>
                            </div>
                            <div>
                                <label class="block font-semibold">Formação Acadêmica</label>
                                <textarea x-model="cvMinsait.formacao" class="w-full p-2 border rounded-lg mt-1" rows="3"></textarea>
                            </div>
                            <div>
                                <label class="block font-semibold">Cursos e Certificações</label>
                                <textarea x-model="cvMinsait.cursos" class="w-full p-2 border rounded-lg mt-1" rows="3"></textarea>
                            </div>
                             <div>
                                <label class="block font-semibold">Idiomas</label>
                                <input type="text" x-model="cvMinsait.idiomas" class="w-full p-2 border rounded-lg mt-1">
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button type="button" @click="closeModal()" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 mr-3">Cancelar</button>
                        <button @click="exportarCVMinsait" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Exportar para Word</button>
                    </div>
                </div>
            </template>

        </div>
    </div>
    
    <!-- Toast Notification -->
    <div x-show="toast.show" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform translate-y-2" x-transition:enter-end="opacity-100 transform translate-y-0" x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100 transform translate-y-0" x-transition:leave-end="opacity-0 transform translate-y-2" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center" x-cloak>
        <i class="mr-3 text-xl" :class="toast.icon"></i>
        <span x-text="toast.message"></span>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, setDoc, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import Alpine from 'https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/module.esm.js';

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDjcSnh9k5MpJzfIGhIMEEpphPByjfTvO0",
          authDomain: "ds-recruiter-pro-minsait.firebaseapp.com",
          projectId: "ds-recruiter-pro-minsait",
          storageBucket: "ds-recruiter-pro-minsait.appspot.com",
          messagingSenderId: "490483424741",
          appId: "1:490483424741:web:3e137817329ef1b1dfe30c",
          measurementId: "G-DEG258LFR9"
        };

        function app() {
            return {
                // State
                sidebarOpen: true,
                activeTab: 'dashboard',
                modal: { open: false, type: null },
                toast: { show: false, message: '', type: 'info', icon: '' },
                editMode: false,
                isLoading: true,
                
                // Firebase
                db: null,
                auth: null,

                // Data
                vagas: [],
                candidatos: [],
                formVaga: { id: null, titulo: '', descricao: '', status: 'Ativa' },
                candidatoSelecionado: null,
                
                // Upload
                uploadedFiles: [],
                vagaParaAnalise: '',

                // Dashboard
                filtroPratica: 'Desenvolvimento de Soluções',
                praticaChartInstance: null,

                // CV Minsait
                cvMinsait: {
                    resumo: '',
                    historico: '',
                    formacao: '',
                    cursos: '',
                    idiomas: ''
                },

                // Initialization
                init() {
                    this.initFirebase();
                    
                    // Responsive sidebar
                    if (window.innerWidth < 768) {
                        this.sidebarOpen = false;
                    }
                    window.addEventListener('resize', () => {
                        this.sidebarOpen = window.innerWidth >= 768;
                    });
                    
                    this.$watch('activeTab', () => this.$nextTick(() => this.initCharts()));
                    this.$watch('candidatos', () => this.$nextTick(() => this.initCharts()));
                },

                initFirebase() {
                    try {
                        const app = initializeApp(firebaseConfig);
                        this.db = getFirestore(app);
                        this.auth = getAuth(app);

                        onAuthStateChanged(this.auth, (user) => {
                            if (user) {
                                this.showToast('Autenticado com sucesso!', 'success');
                                this.loadData();
                            } else {
                                signInAnonymously(this.auth).catch(error => {
                                    console.error("Anonymous sign-in failed:", error);
                                    this.showToast(`Falha na autenticação: ${error.message}. Verifique as configurações do Firebase.`, 'error');
                                });
                            }
                        });
                    } catch (e) {
                        console.error("Firebase initialization failed:", e);
                        this.showToast('Configuração do Firebase ausente ou inválida.', 'error');
                    }
                },

                loadData() {
                    this.isLoading = true;
                    // Load Vagas
                    const vagasCollection = collection(this.db, 'vagas');
                    onSnapshot(vagasCollection, (snapshot) => {
                        this.vagas = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                        this.isLoading = false;
                    }, (error) => {
                        console.error("Error loading vagas:", error);
                        this.showToast("Erro ao carregar vagas.", "error");
                        this.isLoading = false;
                    });

                    // Load Candidatos
                    const candidatosCollection = collection(this.db, 'candidatos');
                    onSnapshot(candidatosCollection, (snapshot) => {
                        this.candidatos = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    }, (error) => {
                        console.error("Error loading candidatos:", error);
                        this.showToast("Erro ao carregar candidatos.", "error");
                    });
                },

                // UI & Modals
                changeTab(tab) { this.activeTab = tab; },
                openModal(type) {
                    this.modal.type = type;
                    this.modal.open = true;
                    if (type !== 'novaVaga' || !this.editMode) {
                        this.resetForms();
                    }
                },
                closeModal() {
                    this.modal.open = false;
                    this.editMode = false;
                    this.candidatoSelecionado = null; // Reset selected candidate on close
                    this.resetForms();
                },
                showToast(message, type = 'info') {
                    this.toast.message = message;
                    this.toast.type = type;
                    if(type === 'success') this.toast.icon = 'bi bi-check-circle-fill text-green-400';
                    else if(type === 'error') this.toast.icon = 'bi bi-x-circle-fill text-red-400';
                    else this.toast.icon = 'bi bi-info-circle-fill text-blue-400';
                    
                    this.toast.show = true;
                    setTimeout(() => this.toast.show = false, 3000);
                },
                resetForms() {
                    this.formVaga = { id: null, titulo: '', descricao: '', status: 'Ativa' };
                    this.uploadedFiles = [];
                    this.vagaParaAnalise = '';
                },

                // Vagas Logic
                async salvarVaga() {
                    if (!this.formVaga.titulo || !this.formVaga.descricao) {
                        this.showToast('Título e descrição são obrigatórios.', 'error');
                        return;
                    }
                    try {
                        const plainFormVaga = {
                            titulo: this.formVaga.titulo,
                            descricao: this.formVaga.descricao,
                            status: this.formVaga.status,
                        };

                        if (this.editMode) {
                            plainFormVaga.updatedAt = serverTimestamp();
                            const vagaRef = doc(this.db, 'vagas', this.formVaga.id);
                            await updateDoc(vagaRef, plainFormVaga);
                            this.showToast('Vaga atualizada com sucesso!', 'success');
                        } else {
                            plainFormVaga.createdAt = serverTimestamp();
                            await addDoc(collection(this.db, 'vagas'), plainFormVaga);
                            this.showToast('Vaga criada com sucesso!', 'success');
                        }
                        this.closeModal();
                    } catch (e) {
                        console.error("Erro ao salvar vaga:", e);
                        this.showToast(`Erro ao salvar vaga: ${e.message}`, 'error');
                    }
                },
                editarVaga(vaga) {
                    this.editMode = true;
                    this.formVaga = { ...vaga };
                    this.openModal('novaVaga');
                },
                async excluirVaga(id) {
                    if (confirm('Tem certeza que deseja excluir esta vaga?')) {
                        try {
                            await deleteDoc(doc(this.db, 'vagas', id));
                            this.showToast('Vaga excluída com sucesso.', 'success');
                        } catch (e) {
                            this.showToast(`Erro ao excluir vaga: ${e.message}`, 'error');
                        }
                    }
                },
                verVaga(vaga) {
                    alert(`Título: ${vaga.titulo}\nStatus: ${vaga.status}\nDescrição: ${vaga.descricao}`);
                },
                contarCandidatosPorVaga(vagaId) {
                    return this.candidatos.filter(c => c.scores && c.scores[vagaId]).length;
                },
                getVagaById(vagaId) {
                    return this.vagas.find(v => v.id === vagaId);
                },

                // Candidatos & CVs Logic
                handleFileUpload(event) {
                    this.uploadedFiles = [...event.target.files];
                },
                async processarUploads() {
                    if (this.uploadedFiles.length === 0) return;
                    
                    this.showToast(`Processando ${this.uploadedFiles.length} CVs...`, 'info');
                    
                    for (const file of this.uploadedFiles) {
                        const nomeCandidato = file.name.replace(/\.(pdf|docx)$/i, '').replace(/_/g, ' ');
                        const pratica = this.simularAnalisePratica(nomeCandidato);

                        const novoCandidato = {
                            nome: nomeCandidato,
                            email: '',
                            cpf: '',
                            cep: '',
                            endereco: '',
                            origem: 'Upload',
                            pratica: pratica,
                            scores: {},
                            scorePratica: Math.random() * 5 + 5,
                            jornada: {
                                status: 'Não iniciado',
                                dataEntrevista: '',
                                gestor: '',
                                conviteEnviado: false,
                            },
                            obs_recrutador: '',
                            obs_cv: `CV original: ${file.name}`,
                            obs_cliente: '',
                            feedback_ia: 'Análise inicial da IA: candidato com potencial, habilidades em X e Y detectadas.',
                            feedback_cliente: '',
                            feedback_prova: '',
                            createdAt: serverTimestamp()
                        };

                        try {
                            const docRef = await addDoc(collection(this.db, 'candidatos'), novoCandidato);
                            
                            if (this.vagaParaAnalise) {
                                this.analisarCandidatoParaVaga(docRef.id, this.vagaParaAnalise);
                            }

                        } catch (e) {
                            console.error("Erro ao adicionar candidato:", e);
                            this.showToast(`Erro ao adicionar candidato ${nomeCandidato}: ${e.message}`, 'error');
                        }
                    }
                    
                    this.showToast('Processamento de CVs concluído!', 'success');
                    this.closeModal();
                },
                simularAnalisePratica(nome) {
                    const praticas = ['Desenvolvimento de Soluções', 'Infra/DIC', 'Dados'];
                    let hash = 0;
                    for (let i = 0; i < nome.length; i++) {
                        hash = nome.charCodeAt(i) + ((hash << 5) - hash);
                    }
                    return praticas[Math.abs(hash) % praticas.length];
                },
                async analisarCandidatoParaVaga(candidatoId, vagaId) {
                    const vaga = this.getVagaById(vagaId);
                    if (!vaga) {
                        this.showToast('Vaga para análise não encontrada.', 'error');
                        return;
                    }
                    
                    const scoreExperiencia = (Math.random() * 10) * 0.30;
                    const scoreHabilidades = (Math.random() * 10) * 0.25;
                    const scoreEducacao = (Math.random() * 10) * 0.10;
                    const scoreIdiomas = (Math.random() * 10) * 0.10;
                    const scorePontosFortes = (Math.random() * 10) * 0.15;
                    const descontoPontosFracos = (Math.random() * 10) * 0.10;
                    const totalScore = scoreExperiencia + scoreHabilidades + scoreEducacao + scoreIdiomas + scorePontosFortes - descontoPontosFracos;

                    const scoreData = {
                        total: totalScore,
                        experiencia: scoreExperiencia,
                        habilidades: scoreHabilidades,
                        educacao: scoreEducacao,
                        idiomas: scoreIdiomas,
                        pontosFortes: scorePontosFortes,
                        pontosFracos: descontoPontosFracos,
                    };

                    try {
                        const candidatoRef = doc(this.db, 'candidatos', candidatoId);
                        await updateDoc(candidatoRef, {
                            [`scores.${vagaId}`]: scoreData
                        });
                        this.showToast(`Análise para ${vaga.titulo} concluída.`, 'success');
                    } catch (e) {
                        this.showToast(`Erro ao salvar score: ${e.message}`, 'error');
                    }
                },
                verCandidato(candidato) {
                    // Ensure jornada object exists
                    if (!candidato.jornada) {
                        candidato.jornada = { status: 'Não iniciado', dataEntrevista: '', gestor: '', conviteEnviado: false };
                    }
                    this.candidatoSelecionado = candidato;
                    this.openModal('verCandidato');
                },
                async salvarCandidato(candidato) {
                    try {
                        const candidatoRef = doc(this.db, 'candidatos', candidato.id);
                        // Create a copy to avoid saving Alpine's reactivity proxies
                        const dataToSave = JSON.parse(JSON.stringify(candidato));
                        delete dataToSave.id; // Don't save the id inside the document
                        await updateDoc(candidatoRef, dataToSave);
                        this.showToast('Dados do candidato salvos.', 'success');
                    } catch(e) {
                        this.showToast(`Erro ao salvar dados: ${e.message}`, 'error');
                        console.error(e);
                    }
                },
                 async buscarCep(candidato) {
                    const cep = candidato.cep.replace(/\D/g, '');
                    if (cep.length !== 8) {
                        this.showToast('CEP inválido.', 'error');
                        return;
                    }
                    try {
                        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                        if (!response.ok) throw new Error('Falha ao buscar CEP');
                        const data = await response.json();
                        if (data.erro) {
                            this.showToast('CEP não encontrado.', 'error');
                            candidato.endereco = 'CEP não encontrado.';
                        } else {
                            candidato.endereco = `${data.logradouro}, ${data.bairro}, ${data.localidade} - ${data.uf}`;
                            this.showToast('Endereço encontrado!', 'success');
                        }
                        this.salvarCandidato(candidato);
                    } catch (e) {
                        this.showToast(`Erro na API de CEP: ${e.message}`, 'error');
                    }
                },
                getVagaPrincipal(candidato) {
                    if (!candidato.scores || Object.keys(candidato.scores).length === 0) {
                        return null;
                    }
                    const vagaIdPrincipal = Object.keys(candidato.scores).reduce((a, b) => candidato.scores[a].total > candidato.scores[b].total ? a : b);
                    return this.getVagaById(vagaIdPrincipal);
                },

                // CV Minsait Logic
                gerarCVMinsait(candidato) {
                    this.candidatoSelecionado = candidato;
                    this.cvMinsait = {
                        resumo: `Profissional com experiência em ${candidato.pratica}, com habilidades demonstradas em projetos de alta complexidade.`,
                        historico: `Atuou em diversas empresas do setor, contribuindo para o desenvolvimento de soluções inovadoras. Última posição: Especialista em ${candidato.pratica}.`,
                        formacao: `Graduado em Sistemas de Informação pela Universidade Exemplo.`,
                        cursos: `Certificação em ${candidato.pratica} Avançado.`,
                        idiomas: `Inglês: Fluente`
                    };
                    this.openModal('gerarCVMinsait');
                },
                exportarCVMinsait() {
                    const { nome } = this.candidatoSelecionado;
                    const { resumo, historico, formacao, cursos, idiomas } = this.cvMinsait;
                    const content = `
                        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                        <head><meta charset='utf-8'><title>CV Minsait - ${nome}</title></head>
                        <body>
                            <h1>${nome}</h1><p>São Paulo - SP</p>
                            <h2>Resumo Profissional</h2><p>${resumo.replace(/\n/g, '<br>')}</p>
                            <h2>Histórico Profissional</h2><p>${historico.replace(/\n/g, '<br>')}</p>
                            <h2>Formação Acadêmica</h2><p>${formacao.replace(/\n/g, '<br>')}</p>
                            <h2>Cursos e Certificações</h2><p>${cursos.replace(/\n/g, '<br>')}</p>
                            <h2>Idiomas</h2><p>${idiomas}</p>
                        </body></html>`;
                    
                    const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(content);
                    const fileDownload = document.createElement("a");
                    document.body.appendChild(fileDownload);
                    fileDownload.href = source;
                    fileDownload.download = `CV_Minsait_${nome.replace(/ /g, '_')}.doc`;
                    fileDownload.click();
                    document.body.removeChild(fileDownload);
                    this.showToast('CV exportado com sucesso!', 'success');
                    this.closeModal();
                },

                // Dashboard & Entrevistas Logic
                entrevistasAgendadas() {
                    return this.candidatos.filter(c => c.jornada && c.jornada.status === 'Entrevista Agendada');
                },
                aguardandoFeedback() {
                    return this.candidatos.filter(c => c.jornada && c.jornada.status && c.jornada.status.includes('Aguardando'));
                },
                formatarData(dataString) {
                    if (!dataString) return 'N/A';
                    const [ano, mes, dia] = dataString.split('-');
                    return `${dia}/${mes}/${ano}`;
                },
                calcularDiasAguardando(dataEntrevista) {
                    if (!dataEntrevista) return 'N/A';
                    const data = new Date(dataEntrevista);
                    const hoje = new Date();
                    const diffTime = Math.abs(hoje - data);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays;
                },
                getStatusClass(status) {
                    if (!status) return 'bg-gray-200 text-gray-800';
                    if (status.includes('Aguardando')) return 'bg-yellow-200 text-yellow-800';
                    if (status.includes('Agendada')) return 'bg-blue-200 text-blue-800';
                    if (status.includes('Aprovado')) return 'bg-green-200 text-green-800';
                    if (status.includes('Reprovado')) return 'bg-red-200 text-red-800';
                    return 'bg-gray-200 text-gray-800';
                },
                calcularScoreMedioPratica() {
                    const candidatosComScore = this.candidatos.filter(c => c.scorePratica);
                    if (candidatosComScore.length === 0) return 'N/A';
                    const total = candidatosComScore.reduce((acc, c) => acc + c.scorePratica, 0);
                    return (total / candidatosComScore.length).toFixed(2);
                },
                rankingPorPratica() {
                    return this.candidatos
                        .filter(c => c.pratica === this.filtroPratica && c.scorePratica)
                        .sort((a, b) => b.scorePratica - a.scorePratica)
                        .slice(0, 10);
                },
                initCharts() {
                    this.initPraticaChart();
                },
                initPraticaChart() {
                    const ctx = document.getElementById('praticaChart')?.getContext('2d');
                    if (!ctx) return;

                    const counts = this.candidatos.reduce((acc, c) => {
                        acc[c.pratica] = (acc[c.pratica] || 0) + 1;
                        return acc;
                    }, {});

                    const labels = Object.keys(counts);
                    const data = Object.values(counts);

                    if (this.praticaChartInstance) {
                        this.praticaChartInstance.destroy();
                    }
                    
                    this.praticaChartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b'],
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: false
                                }
                            }
                        }
                    });
                }
            }
        }

        // Initialize AlpineJS
        window.Alpine = Alpine
        Alpine.data('app', app)
        Alpine.start()
    </script>
</body>
</html>
